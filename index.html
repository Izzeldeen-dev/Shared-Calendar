<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeContent - Shared Calendar</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #111827;
            line-height: 1.6;
        }
        
        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
        }
        
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        .sync-dot.offline {
            background: #ef4444;
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            color: #111827;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #6b7280;
            font-size: 1.1rem;
        }
        
        .top-controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .filters {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filters select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .btn {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
        }
        
        .btn:hover {
            background-color: #1d4ed8;
        }
        
        .btn-success {
            background-color: #16a34a;
        }
        
        .btn-success:hover {
            background-color: #15803d;
        }
        
        .btn-secondary {
            background-color: #6b7280;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        
        .btn-danger {
            background-color: #dc2626;
        }
        
        .btn-danger:hover {
            background-color: #b91c1c;
        }
        
        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .calendar-nav h2 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }
        
        .calendar-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .calendar {
            width: 100%;
        }
        
        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .calendar-header div {
            text-align: center;
            font-weight: 600;
            color: #6b7280;
            padding: 10px;
            font-size: 0.875rem;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .calendar-day {
            min-height: 100px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .calendar-day:hover {
            background-color: #f9fafb;
            border-color: #3b82f6;
        }
        
        .calendar-day.other-month {
            background-color: #f9fafb;
            opacity: 0.5;
        }
        
        .calendar-day.today {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }
        
        .day-number {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.875rem;
        }
        
        .session-item {
            font-size: 0.7rem;
            padding: 2px 4px;
            margin-bottom: 2px;
            border-radius: 3px;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .session-item:hover {
            opacity: 0.8;
        }
        
        .session-session {
            background-color: #dbeafe;
            color: #1e40af;
            border-left: 3px solid #3b82f6;
        }
        
        .session-meeting {
            background-color: #dcfce7;
            color: #166534;
            border-left: 3px solid #16a34a;
        }
        
        .session-followup {
            background-color: #fef3c7;
            color: #92400e;
            border-left: 3px solid #f59e0b;
        }
        
        .session-other {
            background-color: #f3f4f6;
            color: #374151;
            border-left: 3px solid #6b7280;
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .sidebar-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar-section h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #111827;
        }
        
        .today-sessions {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .session-card {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .session-card:hover {
            transform: translateX(5px);
        }
        
        .session-card.session-session {
            background-color: #dbeafe;
            border-left: 4px solid #3b82f6;
        }
        
        .session-card.session-meeting {
            background-color: #dcfce7;
            border-left: 4px solid #16a34a;
        }
        
        .session-card.session-followup {
            background-color: #fef3c7;
            border-left: 4px solid #f59e0b;
        }
        
        .session-card.session-other {
            background-color: #f3f4f6;
            border-left: 4px solid #6b7280;
        }
        
        .session-card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .session-card-time {
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .session-card-type {
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .session-card-client {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 3px;
        }
        
        .session-card-manager {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .legend {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 8px;
            width: 600px;
            max-width: 90%;
        }
        
        .modal h3 {
            margin-bottom: 20px;
            color: #111827;
            font-size: 1.5rem;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 4px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .session-detail-modal .detail-row {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .session-detail-modal .detail-row:last-child {
            border-bottom: none;
        }
        
        .session-detail-modal .detail-label {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        .session-detail-modal .detail-value {
            font-size: 1rem;
            color: #111827;
            font-weight: 500;
        }
        
        .no-sessions {
            text-align: center;
            color: #6b7280;
            padding: 30px;
            font-size: 0.875rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 8px;
            color: white;
        }
        
        .stat-card.blue {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        
        .stat-card.green {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
        }
        
        .stat-card.yellow {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .stat-card h4 {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .client-hours-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .client-hours-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .period-filter {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .period-filter select {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .client-hours-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .client-hours-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.2s;
        }
        
        .client-hours-item:hover {
            background-color: #f9fafb;
        }
        
        .client-hours-item:last-child {
            border-bottom: none;
        }
        
        .client-hours-name {
            font-weight: 500;
            color: #111827;
        }
        
        .client-hours-manager {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 2px;
        }
        
        .client-hours-value {
            font-weight: 700;
            font-size: 1.25rem;
            color: #3b82f6;
        }
        
        .client-hours-sessions {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 2px;
        }
        
        .monthly-breakdown {
            font-size: 0.7rem;
            color: #6b7280;
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px solid #e5e7eb;
        }
        
        .month-stat {
            display: inline-block;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 4px;
            margin-top: 2px;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="sync-indicator">
        <div class="sync-dot" id="sync-dot"></div>
        <span id="sync-status">Connected</span>
    </div>

    <!-- Add Session Modal -->
    <div id="add-session-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">Add New Session</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Account Manager *</label>
                    <select id="session-manager">
                        <option value="">Select account manager</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Client Name *</label>
                    <select id="session-client">
                        <option value="">Select client</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="session-date">
                </div>
                <div class="form-group">
                    <label>Time *</label>
                    <input type="time" id="session-time">
                </div>
                <div class="form-group">
                    <label>Duration (minutes)</label>
                    <input type="number" id="session-duration" value="60" min="15" step="15">
                </div>
                <div class="form-group">
                    <label>Session Type *</label>
                    <select id="session-type">
                        <option value="session">Client Session</option>
                        <option value="meeting">Performance Meeting</option>
                        <option value="followup">Follow-up</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label>Brief Description *</label>
                    <textarea id="session-brief" placeholder="Enter brief description of the session"></textarea>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
                <button class="btn btn-success" id="save-session-btn" onclick="saveSession()">Save Session</button>
            </div>
        </div>
    </div>

    <!-- Session Detail Modal -->
    <div id="detail-modal" class="modal session-detail-modal">
        <div class="modal-content">
            <h3>Session Details</h3>
            <div id="session-details">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-danger" onclick="deleteSession()">Delete</button>
                <button class="btn" onclick="editSession()">Edit</button>
                <button class="btn btn-secondary" onclick="closeDetailModal()">Close</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üìÖ Shared Calendar</h1>
            <p>Track sessions and meetings with clients</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card blue">
                <h4>Total Sessions</h4>
                <div class="stat-value" id="total-sessions">0</div>
            </div>
            <div class="stat-card green">
                <h4>This Month</h4>
                <div class="stat-value" id="month-sessions">0</div>
            </div>
            <div class="stat-card yellow">
                <h4>Today</h4>
                <div class="stat-value" id="today-sessions">0</div>
            </div>
        </div>

        <div class="top-controls">
            <div class="filters">
                <select id="filter-manager" onchange="filterSessions()">
                    <option value="all">All Managers</option>
                </select>
                <select id="filter-client" onchange="filterSessions()">
                    <option value="all">All Clients</option>
                </select>
                <select id="filter-type" onchange="filterSessions()">
                    <option value="all">All Types</option>
                    <option value="session">Client Sessions</option>
                    <option value="meeting">Meetings</option>
                    <option value="followup">Follow-ups</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <button class="btn" onclick="openAddModal()">‚ûï Add Session</button>
        </div>

        <div class="client-hours-section">
            <h3>
                <span>üìä Total Hours per Client</span>
                <div class="period-filter">
                    <label style="font-size: 0.875rem; font-weight: 400;">Period:</label>
                    <select id="hours-period-filter" onchange="updateClientHoursList()">
                        <option value="lifetime">Lifetime</option>
                        <option value="this-month" selected>This Month</option>
                        <option value="last-month">Last Month</option>
                        <option value="last-3-months">Last 3 Months</option>
                        <option value="last-6-months">Last 6 Months</option>
                        <option value="this-year">This Year</option>
                    </select>
                </div>
            </h3>
            <div class="client-hours-list" id="client-hours-list">
            </div>
        </div>

        <div class="calendar-nav">
            <button class="btn btn-secondary" onclick="previousMonth()">‚Üê Previous</button>
            <h2 id="current-month"></h2>
            <button class="btn btn-secondary" onclick="nextMonth()">Next ‚Üí</button>
        </div>

        <div class="main-content">
            <div class="calendar-section">
                <div class="calendar">
                    <div class="calendar-header">
                        <div>Sun</div>
                        <div>Mon</div>
                        <div>Tue</div>
                        <div>Wed</div>
                        <div>Thu</div>
                        <div>Fri</div>
                        <div>Sat</div>
                    </div>
                    <div class="calendar-grid" id="calendar-grid">
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="sidebar-section">
                    <h3>Today's Schedule</h3>
                    <div class="today-sessions" id="today-schedule">
                        <div class="no-sessions">No sessions scheduled for today</div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>Legend</h3>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #3b82f6;"></div>
                            <span>Client Session</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #16a34a;"></div>
                            <span>Performance Meeting</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #f59e0b;"></div>
                            <span>Follow-up</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #6b7280;"></div>
                            <span>Other</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDNMzO17wu4NOaR2TjT419f0IzB-pWzU5M",
            authDomain: "becontent-33415.firebaseapp.com",
            databaseURL: "https://becontent-33415-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "becontent-33415",
            storageBucket: "becontent-33415.firebasestorage.app",
            messagingSenderId: "967557303388",
            appId: "1:967557303388:web:b263a25fea91824710ea99",
            measurementId: "G-Z23YF3S7VQ"
        };

        let database;
        let sessionsRef;
        let clientsRef;
        
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            sessionsRef = database.ref('sessions');
            clientsRef = database.ref('clients');
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }

        let sessions = [];
        let clients = [];
        let currentDate = new Date();
        let currentEditingSessionId = null;
        let currentViewingSessionId = null;

        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('session-date').value = today;
            document.getElementById('session-time').value = '10:00';
            
            renderCalendar();
        });

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            
            document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);
            
            const firstDayOfWeek = firstDay.getDay();
            const lastDateOfMonth = lastDay.getDate();
            const prevLastDate = prevLastDay.getDate();
            
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            
            // Previous month days
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = prevLastDate - i;
                const dayDiv = createDayCell(day, true, year, month - 1);
                calendarGrid.appendChild(dayDiv);
            }
            
            // Current month days
            for (let day = 1; day <= lastDateOfMonth; day++) {
                const dayDiv = createDayCell(day, false, year, month);
                calendarGrid.appendChild(dayDiv);
            }
            
            // Next month days
            const remainingCells = 42 - (firstDayOfWeek + lastDateOfMonth);
            for (let day = 1; day <= remainingCells; day++) {
                const dayDiv = createDayCell(day, true, year, month + 1);
                calendarGrid.appendChild(dayDiv);
            }
        }

        function createDayCell(day, isOtherMonth, year, month) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            
            if (isOtherMonth) {
                dayDiv.classList.add('other-month');
            }
            
            const cellDate = new Date(year, month, day);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            cellDate.setHours(0, 0, 0, 0);
            
            if (cellDate.getTime() === today.getTime()) {
                dayDiv.classList.add('today');
            }
            
            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = day;
            dayDiv.appendChild(dayNumber);
            
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            
            const daySessions = getFilteredSessions().filter(s => s.date === dateStr);
            daySessions.sort((a, b) => a.time.localeCompare(b.time));
            
            daySessions.slice(0, 3).forEach(session => {
                const sessionItem = document.createElement('div');
                sessionItem.className = `session-item session-${session.type}`;
                sessionItem.textContent = `${session.time} ${session.client}`;
                sessionItem.onclick = (e) => {
                    e.stopPropagation();
                    viewSessionDetails(session.id);
                };
                dayDiv.appendChild(sessionItem);
            });
            
            if (daySessions.length > 3) {
                const moreDiv = document.createElement('div');
                moreDiv.className = 'session-item';
                moreDiv.style.fontWeight = '600';
                moreDiv.textContent = `+${daySessions.length - 3} more`;
                dayDiv.appendChild(moreDiv);
            }
            
            dayDiv.onclick = () => {
                openAddModal(dateStr);
            };
            
            return dayDiv;
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function openAddModal(date = null) {
            currentEditingSessionId = null;
            document.getElementById('modal-title').textContent = 'Add New Session';
            document.getElementById('save-session-btn').textContent = 'Save Session';
            
            if (date) {
                document.getElementById('session-date').value = date;
            }
            
            // Reset form
            populateManagerDropdown();
            populateClientDropdown();
            document.getElementById('session-time').value = '10:00';
            document.getElementById('session-duration').value = '60';
            document.getElementById('session-type').value = 'session';
            document.getElementById('session-brief').value = '';
            
            document.getElementById('add-session-modal').style.display = 'block';
        }

        function populateManagerDropdown() {
            const select = document.getElementById('session-manager');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">Select account manager</option>';
            
            // Get unique managers from clients
            const managers = new Set();
            clients.forEach(client => {
                if (client.accountManager && client.accountManager.trim() !== '') {
                    managers.add(client.accountManager.trim());
                }
            });
            
            Array.from(managers).sort().forEach(manager => {
                const option = document.createElement('option');
                option.value = manager;
                option.textContent = manager;
                select.appendChild(option);
            });
            
            // Restore previous value if it exists
            if (currentValue) {
                select.value = currentValue;
            }
        }

        function populateClientDropdown() {
            const select = document.getElementById('session-client');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">Select client</option>';
            
            // Get active clients only
            const activeClients = clients.filter(c => !c.isOffboarded);
            
            activeClients.sort((a, b) => a.name.localeCompare(b.name)).forEach(client => {
                const option = document.createElement('option');
                option.value = client.name;
                option.textContent = client.name;
                select.appendChild(option);
            });
            
            // Restore previous value if it exists
            if (currentValue) {
                select.value = currentValue;
            }
        }

        function getDateRangeForPeriod(period) {
            const today = new Date();
            let startDate, endDate;
            
            switch(period) {
                case 'this-month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'last-month':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
                case 'last-3-months':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 3, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'last-6-months':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 6, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'this-year':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = new Date(today.getFullYear(), 11, 31);
                    break;
                case 'lifetime':
                default:
                    return null; // No filter
            }
            
            return {
                start: startDate.toISOString().split('T')[0],
                end: endDate.toISOString().split('T')[0]
            };
        }

        function calculateClientHours() {
            const period = document.getElementById('hours-period-filter').value;
            const dateRange = getDateRangeForPeriod(period);
            
            const clientHours = {};
            
            // Filter sessions by date range if applicable
            let filteredSessions = sessions;
            if (dateRange) {
                filteredSessions = sessions.filter(s => s.date >= dateRange.start && s.date <= dateRange.end);
            }
            
            // Calculate total hours and monthly breakdown for each client
            filteredSessions.forEach(session => {
                if (!clientHours[session.client]) {
                    // Get manager from clients database if available
                    const clientData = clients.find(c => c.name === session.client);
                    const manager = clientData ? (clientData.accountManager || session.manager) : session.manager;
                    
                    clientHours[session.client] = {
                        totalMinutes: 0,
                        sessionCount: 0,
                        manager: manager,
                        monthlyBreakdown: {}
                    };
                }
                
                clientHours[session.client].totalMinutes += session.duration || 0;
                clientHours[session.client].sessionCount += 1;
                
                // Track monthly breakdown
                const sessionDate = new Date(session.date);
                const monthKey = `${sessionDate.getFullYear()}-${String(sessionDate.getMonth() + 1).padStart(2, '0')}`;
                
                if (!clientHours[session.client].monthlyBreakdown[monthKey]) {
                    clientHours[session.client].monthlyBreakdown[monthKey] = {
                        minutes: 0,
                        count: 0
                    };
                }
                
                clientHours[session.client].monthlyBreakdown[monthKey].minutes += session.duration || 0;
                clientHours[session.client].monthlyBreakdown[monthKey].count += 1;
            });
            
            return clientHours;
        }

        function formatMonthKey(monthKey) {
            const [year, month] = monthKey.split('-');
            const date = new Date(year, parseInt(month) - 1);
            return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        }

        function updateClientHoursList() {
            const container = document.getElementById('client-hours-list');
            const clientHours = calculateClientHours();
            const period = document.getElementById('hours-period-filter').value;
            
            if (Object.keys(clientHours).length === 0) {
                container.innerHTML = '<div class="no-sessions">No sessions tracked for this period</div>';
                return;
            }
            
            // Sort by total hours (descending)
            const sortedClients = Object.entries(clientHours).sort((a, b) => b[1].totalMinutes - a[1].totalMinutes);
            
            container.innerHTML = '';
            sortedClients.forEach(([clientName, data]) => {
                const hours = Math.floor(data.totalMinutes / 60);
                const minutes = data.totalMinutes % 60;
                const hoursText = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
                
                // Create monthly breakdown HTML
                let monthlyBreakdownHtml = '';
                if (period === 'lifetime' || period === 'last-3-months' || period === 'last-6-months' || period === 'this-year') {
                    const sortedMonths = Object.entries(data.monthlyBreakdown).sort((a, b) => b[0].localeCompare(a[0]));
                    monthlyBreakdownHtml = '<div class="monthly-breakdown">';
                    sortedMonths.forEach(([monthKey, monthData]) => {
                        const monthHours = Math.floor(monthData.minutes / 60);
                        const monthMinutes = monthData.minutes % 60;
                        const monthHoursText = monthHours > 0 ? `${monthHours}h ${monthMinutes}m` : `${monthMinutes}m`;
                        monthlyBreakdownHtml += `<span class="month-stat">${formatMonthKey(monthKey)}: ${monthHoursText} (${monthData.count} session${monthData.count !== 1 ? 's' : ''})</span>`;
                    });
                    monthlyBreakdownHtml += '</div>';
                }
                
                const item = document.createElement('div');
                item.className = 'client-hours-item';
                item.innerHTML = `
                    <div style="flex: 1;">
                        <div class="client-hours-name">${clientName}</div>
                        <div class="client-hours-manager">${data.manager}</div>
                        ${monthlyBreakdownHtml}
                    </div>
                    <div style="text-align: right;">
                        <div class="client-hours-value">${hoursText}</div>
                        <div class="client-hours-sessions">${data.sessionCount} session${data.sessionCount !== 1 ? 's' : ''}</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function closeAddModal() {
            document.getElementById('add-session-modal').style.display = 'none';
            currentEditingSessionId = null;
        }

        function saveSession() {
            const manager = document.getElementById('session-manager').value;
            const client = document.getElementById('session-client').value;
            const date = document.getElementById('session-date').value;
            const time = document.getElementById('session-time').value;
            const duration = parseInt(document.getElementById('session-duration').value);
            const type = document.getElementById('session-type').value;
            const brief = document.getElementById('session-brief').value.trim();

            if (!manager) {
                alert('Please select an account manager');
                return;
            }
            
            if (!client) {
                alert('Please select a client');
                return;
            }
            
            if (!date || !time || !brief) {
                alert('Please fill in all required fields');
                return;
            }

            const sessionData = {
                manager: manager,
                client: client,
                date: date,
                time: time,
                duration: duration,
                type: type,
                brief: brief,
                createdAt: new Date().toISOString()
            };

            if (currentEditingSessionId) {
                sessionData.id = currentEditingSessionId;
                sessionData.updatedAt = new Date().toISOString();
                sessionsRef.child(currentEditingSessionId).set(sessionData);
                alert('Session updated successfully!');
            } else {
                const newId = Date.now().toString();
                sessionData.id = newId;
                sessionsRef.child(newId).set(sessionData);
                alert('Session added successfully!');
            }

            closeAddModal();
        }

        function viewSessionDetails(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;

            currentViewingSessionId = sessionId;

            const typeLabels = {
                'session': 'Client Session',
                'meeting': 'Performance Meeting',
                'followup': 'Follow-up',
                'other': 'Other'
            };

            const detailsDiv = document.getElementById('session-details');
            detailsDiv.innerHTML = `
                <div class="detail-row">
                    <div class="detail-label">Account Manager</div>
                    <div class="detail-value">${session.manager}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Client</div>
                    <div class="detail-value">${session.client}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Date & Time</div>
                    <div class="detail-value">${new Date(session.date).toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    })} at ${session.time}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Duration</div>
                    <div class="detail-value">${session.duration} minutes</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Type</div>
                    <div class="detail-value">${typeLabels[session.type]}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Brief Description</div>
                    <div class="detail-value">${session.brief}</div>
                </div>
            `;

            document.getElementById('detail-modal').style.display = 'block';
        }

        function closeDetailModal() {
            document.getElementById('detail-modal').style.display = 'none';
            currentViewingSessionId = null;
        }

        function editSession() {
            const session = sessions.find(s => s.id === currentViewingSessionId);
            if (!session) return;

            currentEditingSessionId = session.id;
            
            document.getElementById('modal-title').textContent = 'Edit Session';
            document.getElementById('save-session-btn').textContent = 'Update Session';
            
            // Populate dropdowns first
            populateManagerDropdown();
            populateClientDropdown();
            
            // Then set values
            document.getElementById('session-manager').value = session.manager;
            document.getElementById('session-client').value = session.client;
            document.getElementById('session-date').value = session.date;
            document.getElementById('session-time').value = session.time;
            document.getElementById('session-duration').value = session.duration;
            document.getElementById('session-type').value = session.type;
            document.getElementById('session-brief').value = session.brief;
            
            closeDetailModal();
            document.getElementById('add-session-modal').style.display = 'block';
        }

        function deleteSession() {
            if (!currentViewingSessionId) return;

            if (confirm('Are you sure you want to delete this session?')) {
                sessionsRef.child(currentViewingSessionId).remove();
                closeDetailModal();
                alert('Session deleted successfully!');
            }
        }

        function updateTodaySchedule() {
            const today = new Date().toISOString().split('T')[0];
            const todaySessions = getFilteredSessions().filter(s => s.date === today);
            todaySessions.sort((a, b) => a.time.localeCompare(b.time));

            const container = document.getElementById('today-schedule');
            
            if (todaySessions.length === 0) {
                container.innerHTML = '<div class="no-sessions">No sessions scheduled for today</div>';
                return;
            }

            container.innerHTML = '';
            todaySessions.forEach(session => {
                const card = document.createElement('div');
                card.className = `session-card session-${session.type}`;
                card.onclick = () => viewSessionDetails(session.id);
                
                const typeLabels = {
                    'session': 'Session',
                    'meeting': 'Meeting',
                    'followup': 'Follow-up',
                    'other': 'Other'
                };
                
                card.innerHTML = `
                    <div class="session-card-header">
                        <div class="session-card-time">${session.time}</div>
                        <div class="session-card-type">${typeLabels[session.type]}</div>
                    </div>
                    <div class="session-card-client">${session.client}</div>
                    <div class="session-card-manager">${session.manager}</div>
                `;
                
                container.appendChild(card);
            });
        }

        function updateStats() {
            const filteredSessions = getFilteredSessions();
            document.getElementById('total-sessions').textContent = filteredSessions.length;

            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth();
            const monthSessions = filteredSessions.filter(s => {
                const sessionDate = new Date(s.date);
                return sessionDate.getFullYear() === currentYear && sessionDate.getMonth() === currentMonth;
            });
            document.getElementById('month-sessions').textContent = monthSessions.length;

            const today = new Date().toISOString().split('T')[0];
            const todaySessions = filteredSessions.filter(s => s.date === today);
            document.getElementById('today-sessions').textContent = todaySessions.length;
            
            updateClientHoursList();
        }

        function getFilteredSessions() {
            const managerFilter = document.getElementById('filter-manager').value;
            const clientFilter = document.getElementById('filter-client').value;
            const typeFilter = document.getElementById('filter-type').value;

            return sessions.filter(session => {
                if (managerFilter !== 'all' && session.manager !== managerFilter) return false;
                if (clientFilter !== 'all' && session.client !== clientFilter) return false;
                if (typeFilter !== 'all' && session.type !== typeFilter) return false;
                return true;
            });
        }

        function filterSessions() {
            renderCalendar();
            updateTodaySchedule();
            updateStats();
        }

        function updateFilters() {
            // Get unique managers from clients database
            const managers = new Set();
            clients.forEach(client => {
                if (client.accountManager && client.accountManager.trim() !== '') {
                    managers.add(client.accountManager.trim());
                }
            });

            // Get unique clients from sessions (to show all clients that have sessions)
            const clientsInSessions = new Set();
            sessions.forEach(session => {
                clientsInSessions.add(session.client);
            });

            const managerFilter = document.getElementById('filter-manager');
            const currentManager = managerFilter.value;
            managerFilter.innerHTML = '<option value="all">All Managers</option>';
            Array.from(managers).sort().forEach(manager => {
                const option = document.createElement('option');
                option.value = manager;
                option.textContent = manager;
                managerFilter.appendChild(option);
            });
            managerFilter.value = currentManager;

            const clientFilter = document.getElementById('filter-client');
            const currentClient = clientFilter.value;
            clientFilter.innerHTML = '<option value="all">All Clients</option>';
            Array.from(clientsInSessions).sort().forEach(client => {
                const option = document.createElement('option');
                option.value = client;
                option.textContent = client;
                clientFilter.appendChild(option);
            });
            clientFilter.value = currentClient;
        }

        function updateSyncIndicator(isConnected) {
            const dot = document.getElementById('sync-dot');
            const status = document.getElementById('sync-status');
            
            if (isConnected) {
                dot.classList.remove('offline');
                status.textContent = 'Connected';
            } else {
                dot.classList.add('offline');
                status.textContent = 'Offline';
            }
        }

        window.onclick = function(event) {
            const addModal = document.getElementById('add-session-modal');
            const detailModal = document.getElementById('detail-modal');
            
            if (event.target === addModal) {
                closeAddModal();
            }
            if (event.target === detailModal) {
                closeDetailModal();
            }
        }

        sessionsRef.on('value', (snapshot) => {
            sessions = [];
            snapshot.forEach((childSnapshot) => {
                sessions.push(childSnapshot.val());
            });
            
            updateFilters();
            renderCalendar();
            updateTodaySchedule();
            updateStats();
        });

        clientsRef.on('value', (snapshot) => {
            clients = [];
            snapshot.forEach((childSnapshot) => {
                clients.push(childSnapshot.val());
            });
            
            updateFilters();
            updateClientHoursList();
        });

        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snapshot) => {
            updateSyncIndicator(snapshot.val() === true);
        });
    </script>
</body>
</html>
